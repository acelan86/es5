<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>测试</title>
        <link rel="stylesheet" href="./qunit.css" type="text/css"/>
        <script type="text/javascript" src="./qunit.js"></script>
    </head>
    <body>
        <h1 id="qunit-header">QUnit Test Suite</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script src="../ES_Helper.js"></script>

        <script src="../ES_Global.js"></script>
        <script src="../Type/ES_ST_PropertyDescriptor.js"></script>
        <script src="../Type/ES_ST_DeclarativeEnvironmentRecords.js"></script>
        <script src="../Type/ES_ST_ObjectEnvironmentRecords.js"></script>
        <script src="../Type/ES_ST_LexicalEnvrionment.js"></script>
        <script src="../Type/ES_ST_Reference.js"></script>

        <script src="../ES_Object.js"></script>

        <script src="../prototype/ES_objectPrototype.js"></script>
        <script src="../prototype/ES_functionPrototype.js"></script>
        <script src="../prototype/ES_booleanPrototype.js"></script>
        <script src="../prototype/ES_numberPrototype.js"></script>
        <script src="../prototype/ES_stringPrototype.js"></script>

        <script src="../ES_Arguments.js"></script>

        <script src="../constructor/ES_objectConstructor.js"></script>
        <script src="../constructor/ES_functionConstructor.js"></script>
        <script src="../constructor/ES_booleanConstructor.js"></script>
        <script src="../constructor/ES_numberConstructor.js"></script>
        <script src="../constructor/ES_stringConstructor.js"></script>

        <script src="../ES_GlobalObject.js"></script>
        <script src="../ES_ExecuteContext.js"></script>
        <script src="../ES_globalEC.js"></script>

        <script src="../ES_throwTypeError.js"></script>

        <script src="../ES_control.js"></script>


        <!-- 引入表达式相关定义 -->
        <script src="../expressions/ES_Statements.js"></script>
        <script src="../expressions/ES_FunctionDefinition.js"></script>
        <script src="../expressions/ES_LeftHandSideExpressions.js"></script>

        <script>
            // var dataDesc = new ES_ST_PropertyDescriptor({
            //     __Value__ : 1,
            //     __Writable__ : true,
            //     __Enumerable__ : true,
            //     __Configurable__ : true
            // });

            // var accessorDesc = new ES_ST_PropertyDescriptor({
            //     __Get__ : function () {},
            //     __Set__ : function () {},
            //     __Enumerable__ : true,
            //     __Configurable__ : true
            // });

            // var genericDesc = new ES_ST_PropertyDescriptor({});

            // var newObj = ES_objectConstructor.__Construct__(),
            //     dataObj,
            //     accessorObj,
            //     genericObj;

            // test('ES_ST_PropertyDescriptor.isAccessorDescriptor', function () {
            //     ok(!ES_ST_PropertyDescriptor.isAccessorDescriptor(undefined), 'undefined is not accessorDescriptor');
            //     ok(!ES_ST_PropertyDescriptor.isAccessorDescriptor(dataDesc), 'dataDesc is not accessorDescriptor');
            //     ok(ES_ST_PropertyDescriptor.isAccessorDescriptor(accessorDesc), 'accessorDesc is accessorDescriptor');
            //     ok(!ES_ST_PropertyDescriptor.isAccessorDescriptor(genericDesc), 'genericDesc is not accessorDescriptor');
            // });
            // test('ES_ST_PropertyDescriptor.isDataDescriptor', function () {
            //     ok(!ES_ST_PropertyDescriptor.isDataDescriptor(undefined), 'undefined is not dataDescriptor');
            //     ok(ES_ST_PropertyDescriptor.isDataDescriptor(dataDesc), 'dataDesc is dataDescriptor');
            //     ok(!ES_ST_PropertyDescriptor.isDataDescriptor(accessorDesc), 'accessorDesc is not dataDescriptor');
            //     ok(!ES_ST_PropertyDescriptor.isDataDescriptor(genericDesc), 'genericDesc is not dataDescriptor');
            // });
            // test('ES_ST_PropertyDescriptor.isGenericDescriptor', function () {
            //     ok(!ES_ST_PropertyDescriptor.isGenericDescriptor(undefined), 'undefined is not genericDescriptor');
            //     ok(!ES_ST_PropertyDescriptor.isGenericDescriptor(dataDesc), 'dataDesc is not genericDescriptor');
            //     ok(!ES_ST_PropertyDescriptor.isGenericDescriptor(accessorDesc), 'accessorDesc is not genericDescriptor');
            //     ok(ES_ST_PropertyDescriptor.isGenericDescriptor(genericDesc), 'genericDesc is genericDescriptor');
            // });

            // test('ES_ST_PropertyDescriptor.fromPropertyDescriptor', function () {
            //     var _obj;
            //     ok(dataObj = _obj = ES_ST_PropertyDescriptor.fromPropertyDescriptor(dataDesc), 'dataDesc to object');
            //     console.debug(_obj);
            //     ok(accessorObj = _obj = ES_ST_PropertyDescriptor.fromPropertyDescriptor(accessorDesc), 'accessorDesc to object');
            //     console.debug(_obj);
            //     ok(genericObj = _obj = ES_ST_PropertyDescriptor.fromPropertyDescriptor(genericDesc), 'genericDesc to object');
            //     console.debug(_obj);
            // });

            // test('ES_ST_PropertyDescriptor.toPropertyDescriptor', function () {
            //     var _desc;
            //     ok(_desc = ES_ST_PropertyDescriptor.toPropertyDescriptor(newObj), 'newObj to desc');
            //     console.debug(_desc);
            //     ok(_desc = ES_ST_PropertyDescriptor.toPropertyDescriptor(dataObj), 'dataObj to dataDesc');
            //     console.debug(_desc);
            //     ok(_desc = ES_ST_PropertyDescriptor.toPropertyDescriptor(accessorObj), 'accessorObj to accessorDesc');
            //     console.debug(_desc);
            //     ok(_desc = ES_ST_PropertyDescriptor.toPropertyDescriptor(genericObj), 'genericObj to genericDesc');
            //     console.debug(_desc);
            // });


            // var opOwnProperty = ["es_constructor", "es_valueOf", "es_toString", "es_hasOwnProperty", "es_toLocalString", "es_isPrototypeOf", "es_propertyIsEnumerable"],
            //     fpOwnProperty = ["es_constructor", "es_toString", "es_length", "es_apply"],
            //     oOwnProperty = [],
            //     fOwnProperty = [];

            // test('ES_objectPrototype', function () {
            //     var obj = ES_objectPrototype,
            //         op = opOwnProperty;
            //     strictEqual(obj.__Class__, "Object", "objprototype.__Class__ is 'Object'");
            //     strictEqual(obj.__Prototype__, null, "objprototype.__Prototype__ is null");
            //     for (var i = 0, len = op.length; i < len; i++) {
            //         notStrictEqual(obj.__GetOwnProperty__(op[i]), undefined, op[i] + " is objprototype's ownproperty");
            //         console.debug(obj.__Get__(op[i]));
            //     }
            // });

            // test('ES_functionPrototype', function () {
            //     var obj = ES_functionPrototype,
            //         op = fpOwnProperty,
            //         p = op.concat(opOwnProperty);

            //     strictEqual(obj.__Class__, "Function", "fucprototype.__Class__ is 'Object'");
            //     strictEqual(obj.__Prototype__, ES_objectPrototype, "funcprototype.__Prototype__ is objprototype");

            //     for (var i = 0, len = op.length; i < len; i++) {
            //         notStrictEqual(obj.__GetOwnProperty__(op[i]), undefined, op[i] + " is funcprototype's ownproperty");
            //     }
            //     for (var i = 0, len = p.length; i < len; i++) {
            //         strictEqual(obj.__HasProperty__(p[i]), true, p[i] + " is funcprototype's property");
            //     }
            // });


            // test('ES_Object', function () {
            //     var obj = ES_objectConstructor.__Construct__(),
            //         op = oOwnProperty;
            //         p = op.concat(opOwnProperty);
            //     strictEqual(obj.__Class__, "Object", "obj.__Class__ is 'Object'");
            //     strictEqual(obj.__Prototype__, ES_objectPrototype, "obj.__Prototype__ is ES_objectPrototype");

            //     for (var i = 0, len = op.length; i < len; i++) {
            //         notStrictEqual(obj.__GetOwnProperty__(op[i]), undefined, op[i] + " is object's ownproperty");
            //     }
            //     for (var i = 0, len = p.length; i < len; i++) {
            //         strictEqual(obj.__HasProperty__(p[i]), true, p[i] + " is object's property");
            //     }
            // });

            // test('ES_Function', function () {
            //     var fo = ES_functionConstructor.__Construct__(),
            //         op = fOwnProperty,
            //         p = op.concat(fpOwnProperty).concat(opOwnProperty);
            //     strictEqual(fo.__Class__, "Function", "fo.__Class__ is 'Function'");
            //     strictEqual(fo.__Prototype__, ES_functionPrototype, "fo.__Prototype__ is ES_functionPrototype");
            //     for (var i = 0, len = op.length; i < len; i++) {
            //         notStrictEqual(fo.__GetOwnProperty__(op[i]), undefined, op[i] + " is function's ownproperty");
            //     }
            //     for (var i = 0, len = p.length; i < len; i++) {
            //         strictEqual(fo.__HasProperty__(p[i]), true, p[i] + " is function's property");
            //     }
            // });



            // /**
            //  * 引用类型测试
            //  */


            // test('ES_ST_Reference.getValue', function () {
            //     var primitiveRef = new ES_ST_Reference(1, 'primitiveRef', true),
            //         obj = ES_objectConstructor.__Construct__(),
            //         num = ES_numberConstructor._new(1),
            //         envRec = new ES_ST_DeclarativeEnvironmentRecords(),
            //         oenvRec = new ES_ST_ObjectEnvironmentRecords(obj), 
            //         numRef,
            //         objRef,
            //         envRecRef,
            //         oenvRecRef;

            //         obj.__DefineOwnProperty__(
            //             "objRef",
            //             new ES_ST_PropertyDescriptor({
            //                 __Value__ : "obj"
            //             }),
            //             false
            //         );

            //         envRec.createMutableBinding('envRecRef', true);
            //         envRec.setMutableBinding('envRecRef', 1, true);

            //         envRec.createMutableBinding('oenvRecRef', true);
            //         envRec.setMutableBinding('oenvRecRef', 1, true);

            //         objRef = new ES_ST_Reference(obj, 'objRef', true);
            //         numRef = new ES_ST_Reference(num, 'numRef', true);
            //         envRecRef = new ES_ST_Reference(envRec, 'envRecRef', true);
            //         oenvRecRef = new ES_ST_Reference(oenvRec, 'objRef', true);

            //     strictEqual(ES_ST_Reference.getValue(primitiveRef), 1, 'primitiveRef.value is 1');
            //     strictEqual(ES_ST_Reference.getValue(objRef), "obj", "objRef.value is 'obj'");
            //     strictEqual(ES_ST_Reference.getValue(numRef), 1, "numRef.value is 1");
            //     strictEqual(ES_ST_Reference.getValue(envRecRef), 1, "envRecRef.value is 1");
            //     strictEqual(ES_ST_Reference.getValue(oenvRecRef), 'obj', "oenvRecRef.value is 1");
            // });


            // test('ES_ST_Reference.putValue', function () {
            //     var numRef = new ES_ST_Reference(undefined, 'num', false);
            //     strictEqual(ES_ST_Reference.putValue(numRef, 1), 1, 'num = 1');
            //     strictEqual(ES_ST_Reference.getValue(numRef), undefined, 'numRef.value = 1');
            // });


            // /**
            //  * 测试全局代码与局部代码
            //  */
            // test('ES_control', function () {
            //     var globalCode = [
            //         "globalCode",
            //         "'use strict'",
            //         "var a=1",
            //         "var x=1",
            //         "function a(b,c){}",
            //         "function b(a,d){}"
            //     ];

            //     // 例如下面是全局函数a的funcBody
            //     var funcCode = [
            //         "funcCode",
            //         "'use strict'",
            //         "var b=1",
            //         "var x=1",
            //         "function a(b,c){}"
            //     ];

            //     //进入全局代码
            //     ES_declarationBindingInstantiation(ES_globalEC, globalCode, ES_Global.isStrictCode(globalCode), null);


            //     var funcObj = ES_ST_Reference.getValue(ES_ST_LexicalEnvironment.getIdentifierReference(ES_globalEC.lexicalEnvironment, 'a', true));

            //     funcObj.__Code__ = funcCode;

            //     //进入函数代码
            //     //a(2, 3);
            //     funcObj.__Call__(ES_globalEC.thisBinding, [2, 3]);


            // });
            

            /** ============================
             *  如下代码的解释执行过程
             *  
             *  function abc(e, f) {
             *      function abc(x, y) {
             *          var a;
             *          x;  //undefined
             *          y;  //undefined
             *          e;  //undefined
             *          f;  //undefined
             *          g;  //undefined
             *          
             *      },
             *      var a;
             *      e;   //undefined
             *      f;   //undefined
             *      g;   //undefined
             *      abc(1, 2);
             *  }
             *  var g; //undefined;
             *  abc(1, 2);
             *
             */
            /**
             * 模拟执行函数代码
             */
            var nullCode = {
                codeType : "function",
                strict : true,
                code : []
            };
            var innerCode = {
                codeType : "function",
                strict : true,
                code : [
                    /**
                     * 一个模拟变量声明
                     * var a;
                     */
                    {
                        type : "ES_Statements",
                        exp : "VD : id",
                        args : ["a"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["x"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["y"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["e"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["f"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["g"]
                    }
                ]
            };
            var funcCode = {
                codeType : 'function',
                strict : true,
                code : [
                    //在变量a声明前获取变量
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["a"]
                    },
                    /**
                     * 声明一个与变量a同名的函数a
                     */
                    {
                        type : "ES_FunctionDefinition",
                        exp : "FD : function id(par) {body}",
                        args : [
                            "a",
                            "x,y", 
                            nullCode
                        ]
                    },
                    /**
                     * 一个模拟变量声明
                     * var a;
                     */
                    {
                        type : "ES_Statements",
                        exp : "VD : id",
                        args : ["a"]
                    },
                    /**
                     * 函数调用
                     */
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "CallExpression : memberExp args",
                        args : [
                            {
                                type : "ES_LeftHandSideExpressions",
                                exp : "MemberExpression : IdentifierName",
                                args : ["abc"]
                            },
                            {
                                type : "ES_LeftHandSideExpressions",
                                exp : "Arguments : ()",
                                args : []
                            }
                        ]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["e"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["f"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["g"]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["NoIn"]
                    },
                    /**
                     * 一个模拟的词法分析过的函数声明
                     * function abc(x, y) {
                     *     return x + y;
                     * }
                     */
                    {
                        type : "ES_FunctionDefinition",
                        exp : "FD : function id(par) {body}",
                        args : [
                            "abc",
                            "x,y", 
                            innerCode
                        ]
                    }
                ]
            };

            /**
             * 模拟执行全局代码
             */
            var gloCode = {
                codeType : 'global',
                strict : true,
                code : [
                    /**
                     * 一个模拟的词法分析过的函数声明
                     * function abc(x, y) {
                     *     return x + y;
                     * }
                     */
                    {
                        type : "ES_FunctionDefinition",
                        exp : "FD : function id(par) {body}",
                        args : [
                            "abc",
                            "e,f", 
                            funcCode
                        ]
                    },
                    /**
                     * 一个模拟变量声明
                     * var a;
                     */
                    {
                        type : "ES_Statements",
                        exp : "VD : id",
                        args : ["g"]
                    },
                    /**
                     * 函数调用
                     */
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "CallExpression : memberExp args",
                        args : [
                            {
                                type : "ES_LeftHandSideExpressions",
                                exp : "MemberExpression : IdentifierName",
                                args : ["abc"]
                            },
                            {
                                type : "ES_LeftHandSideExpressions",
                                exp : "Arguments : ()",
                                args : []
                            }
                        ]
                    },
                    {
                        type : "ES_LeftHandSideExpressions",
                        exp : "MemberExpression : IdentifierName",
                        args : ["g"]
                    }
                ]
            };


            (function (gloCode) {
                //preprocessing
                ES_declarationBindingInstantiation(gloCode, ES_Global.isStrictCode(gloCode), null);
                ES_control.run(gloCode);
            })(gloCode);
        </script>
    </body>
</html>